# UI Flow Documentation

## Settings Page - Instance Section

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Settings                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                        â”‚
â”‚  Archive Instance                      â”‚
â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Current Instance    â–¼ Anna's... â”‚ â”‚ <- Dropdown selector
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Manage Instances          âš™ï¸     â”‚ â”‚ <- Opens management page
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                        â”‚
â”‚  General Settings                      â”‚
â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Dark Mode              [Toggle]  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                        â”‚
â”‚  ... (rest of settings)                â”‚
â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Instance Management Page

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â† Manage Instances      [+] [âŸ³]      â”‚ <- Add & Reset buttons
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                        â”‚
â”‚  Archive Instances                     â”‚
â”‚                                        â”‚
â”‚  Drag to reorder priority. App tries  â”‚
â”‚  each enabled instance 2x before      â”‚
â”‚  moving to next.                       â”‚
â”‚                                        â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—   â”‚
â”‚  â•‘ â˜° 1  Anna's Archive (.org)    â•‘   â”‚
â”‚  â•‘      https://annas-archive.org â•‘   â”‚
â”‚  â•‘                         [ON] âŒâ•‘   â”‚ <- Can't delete default
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â˜° 2  Anna's Archive (.gs)     â”‚   â”‚
â”‚  â”‚      https://annas-archive.gs  â”‚   â”‚
â”‚  â”‚                         [ON] âŒâ”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â˜° 3  Anna's Archive (.se)     â”‚   â”‚
â”‚  â”‚      https://annas-archive.se  â”‚   â”‚
â”‚  â”‚                         [ON] âŒâ”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â˜° 4  Anna's Archive (.li)     â”‚   â”‚
â”‚  â”‚      https://annas-archive.li  â”‚   â”‚
â”‚  â”‚                         [ON] âŒâ”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â˜° 5  Anna's Archive (.st)     â”‚   â”‚
â”‚  â”‚      https://annas-archive.st  â”‚   â”‚
â”‚  â”‚                         [ON] âŒâ”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â˜° 6  Anna's Archive (.pm)     â”‚   â”‚
â”‚  â”‚      https://annas-archive.pm  â”‚   â”‚
â”‚  â”‚                         [ON] âŒâ”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â˜° 7  Welib.org                 â”‚   â”‚
â”‚  â”‚      https://welib.org          â”‚   â”‚
â”‚  â”‚                         [ON] âŒâ”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â˜° 8  My Custom Mirror  [Custom]â”‚   â”‚
â”‚  â”‚      https://my-mirror.com      â”‚   â”‚
â”‚  â”‚                         [ON] ğŸ—‘ï¸â”‚   â”‚ <- Can delete custom
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Add Custom Instance Dialog

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Add Custom Instance                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                        â”‚
â”‚  Name                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ My Custom Mirror                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                        â”‚
â”‚  URL                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ https://example.com              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                        â”‚
â”‚           [Cancel]  [Add]              â”‚
â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## User Interaction Flow

### Selecting an Instance
1. User opens Settings page
2. Sees "Current Instance" dropdown
3. Taps dropdown â†’ shows all enabled instances
4. Selects desired instance
5. âœ“ Snackbar: "Instance changed successfully"
6. Future searches use selected instance

### Managing Instances
1. User opens Settings page
2. Taps "Manage Instances"
3. Sees list of all instances with priority numbers
4. Can perform actions:

   **Reorder:**
   - Long press on item
   - Drag to new position
   - Release
   - âœ“ Priority automatically updated

   **Enable/Disable:**
   - Toggle switch on/off
   - âœ“ Change persisted immediately

   **Add Custom:**
   - Tap [+] button
   - Enter name and URL
   - Tap "Add"
   - âœ“ Snackbar: "Instance added successfully"

   **Delete Custom:**
   - Tap ğŸ—‘ï¸ icon on custom instance
   - Confirm in dialog
   - âœ“ Snackbar: "Instance deleted"

   **Reset:**
   - Tap [âŸ³] button
   - âœ“ Snackbar: "Reset to default instances"

### Search with Automatic Failover
1. User searches for a book
2. App uses selected instance (or first enabled)
3. **If successful:** Results displayed immediately
4. **If failed:**
   - Retry on same instance (wait 500ms)
   - If still failed, try next enabled instance
   - Repeat for all enabled instances (2x each)
   - If all fail, show error message

## Failover Visualization

```
Search Initiated
       â†“
Try Instance 1 (Anna's .org)
       â†“
   [Attempt 1]
       â†“
    Success? â”€â”€Yesâ”€â”€â†’ âœ“ Show Results
       â†“ No
   Wait 500ms
       â†“
   [Attempt 2]
       â†“
    Success? â”€â”€Yesâ”€â”€â†’ âœ“ Show Results
       â†“ No
       â†“
Try Instance 2 (Anna's .gs)
       â†“
   [Attempt 1]
       â†“
    Success? â”€â”€Yesâ”€â”€â†’ âœ“ Show Results
       â†“ No
   Wait 500ms
       â†“
   [Attempt 2]
       â†“
    Success? â”€â”€Yesâ”€â”€â†’ âœ“ Show Results
       â†“ No
       â†“
   ... (continue with remaining instances)
       â†“
All instances failed?
       â†“
    âœ— Show Error
```

## Visual Elements

### Instance Card Elements
- **â˜°** - Drag handle (for reordering)
- **Number** - Priority order (1 = tried first)
- **Name** - Display name of instance
- **URL** - Base URL of instance
- **[Custom]** - Badge for custom instances
- **[Toggle]** - Enable/disable switch (Green = ON, Grey = OFF)
- **ğŸ—‘ï¸** - Delete button (only for custom instances)
- **âŒ** - Indicates can't delete (default instances)

### Color Scheme
- **Primary Actions**: Red (brand color)
- **Enabled State**: Green toggle
- **Disabled State**: Grey toggle
- **Custom Badge**: Blue background with blue text
- **Cards**: Theme-dependent (light/dark mode)

### Accessibility
- All interactive elements have appropriate touch targets (minimum 48x48dp)
- Icons have semantic meanings
- Text is readable in both light and dark modes
- Drag handles provide clear affordance for reordering
- Confirmation dialogs for destructive actions

## State Management

### Provider Hierarchy
```
ProviderScope
  â”œâ”€ instanceManagerProvider (Singleton)
  â”œâ”€ archiveInstancesProvider (FutureProvider)
  â”œâ”€ currentInstanceProvider (FutureProvider)
  â””â”€ selectedInstanceIdProvider (StateProvider)
```

### Data Flow
```
User Action
     â†“
UI Widget
     â†“
InstanceManager
     â†“
Database (SQLite)
     â†“
State Update
     â†“
UI Rebuild
```

## Error Handling

### User-Facing Errors
1. **Invalid URL Format**
   - When: Adding custom instance with invalid URL
   - Action: Show snackbar "URL must start with http:// or https://"
   
2. **Cannot Delete Default Instance**
   - When: Attempting to delete built-in instance
   - Action: Show snackbar "Cannot delete default instances"
   
3. **All Instances Failed**
   - When: All enabled instances fail after retries
   - Action: Show error widget with retry button
   
4. **No Enabled Instances**
   - When: All instances are disabled
   - Action: Fall back to default instance automatically

### Developer Errors
- All exceptions logged to console
- Graceful fallbacks prevent app crashes
- Last exception is preserved and can be inspected
